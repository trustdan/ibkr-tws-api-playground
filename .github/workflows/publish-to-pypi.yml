name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install TA-Lib system library
      run: |
        sudo apt-get update
        sudo apt-get install -y libta-lib-dev
        
        # Verify the library is properly installed and registered
        echo "Checking TA-Lib library in system cache:"
        ldconfig -p | grep libta-lib
        ls -la /usr/lib/libta-lib*
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install setuptools wheel twine build
        python -m pip install numpy
        python -m pip install TA-Lib
        
        # Install dependencies
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: Verify TA-Lib installation
      run: |
        python - << 'EOF'
        import ctypes, talib
        # Ensure the C library loads
        ctypes.CDLL('libta-lib.so')
        # Ensure the wrapper finds its symbols
        funcs = talib.get_functions()
        print('TA-Lib functions sample:', funcs[:5])
        EOF
    
    - name: Build and publish
      env:
        TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
        TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
      run: |
        python -m build
        twine upload dist/* 